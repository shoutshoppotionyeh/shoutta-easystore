{% if settings.is_new_promotion_enabled %}

  <style>
    #CartTemplate{
      min-height: 80vh;
    }
    .cart-drawer .cart__row .small--one-whole,
    .cart-drawer .cart-sticky-button-wrapper{
      width: 100%;
    }
    .cart-drawer .promotion__code-input .input-group{
      margin-top: 20px;
      max-width: 100%;
    }
    .cart-drawer-wrapper{
      display: flex;
      flex-wrap: wrap;
      flex-direction: row;
    }
    .cart-drawer-wrapper > div{
      width: 100%;
    }
  </style>

  <div id="CartDrawer" class="cart-drawer" data-fetch="0">
    {% comment %}
      This is your cart drawer
    {% endcomment %}

    <div class="cart-drawer-wrapper">
      {% app_snippet 'cart/content_top' %}

      <div id="CartTemplate">
        {% include "cart-template" %}
      </div>

      {% app_snippet 'cart/content_bottom' %}
    </div>
    

    {% if shop.plan_id == "0" or shop.plan_id == "5" or shop.plan_id == "6" %}
      {% if shop.express_enabled %}
        {% comment %}
        Express checkout dialog 
        {% endcomment %}
        <div id="express-checkout-dialog_sidebar" class="modal__dialog">
          <div class="modal__dialog-bg dialog__close-toggle"></div>
          <div class="modal__dialog-wrapper small__dialog">
            <span class="dialog__close dialog__close-toggle">Ã—</span>
            <div class="modal__dialog-content">
              <div class="modal__dialog-express-checkout">
                <div>
                  <button type="submit" name="expresscheckout" class="btn btn--full checkout">{{ 'cart.general.express_checkout' | t }}</button>
                </div>
                <div>
                  {{ 'cart.general.or' | t }}
                </div>
                <div class="text-center">
                  <button type="submit" name="checkout" class="btn btn--full btn--tertiary checkout">{{ 'cart.general.standard_checkout' | t }}</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <script type="text/javascript">
          $( "#express-checkout-btn_sidebar" ).click(function() {
            var scrollbarWidth = window.innerWidth - document.body.clientWidth;
            $('#express-checkout-dialog_sidebar').addClass('show');
            $('html').css({'overflow': 'hidden','margin-right': scrollbarWidth});
          }
          );
          $( ".dialog__close-toggle" ).click(function() {
            $('#express-checkout-dialog_sidebar').removeClass('show');
            $('html').css({'overflow': '','margin-right': ''});
          });
          $( "button.btn.checkout" ).click(function() {
            $(this).addClass("btn--loading");
          }
          );
        </script>
      {% endif %}
    {% endif %}
  </div>

  <div id="toast"><div id="toastContent"></div></div>
  <style>
    .cart-drawer .cart-drawer-content .cart-sticky-button-wrapper a.btn.CartDrawerTrigger{margin-bottom: 10px !important;}
    #toastContent a{color: #fff;text-decoration: underline;margin-top: 10px;display: block;}
    #toastContent .svg-icon{margin-right: 8px;margin-top: -1px;}
  </style>

  <script type="text/javascript">
    $('body').on("submit", "#CartForm", function() {
      $(this).find('[type=submit]').addClass('btn--loading');
    });
    
    $("input[name=current_currency]").val($( "select.currency-picker" ).val());
    $( "select.currency-picker" ).change(function(){
      $("select.currency-picker").val($(this).val());
      url=window.location.href;
      newParam="currency=" + $( "select.currency-picker" ).val();
      if(url.indexOf("currency=")===-1){
        separator = (url.indexOf("?")===-1)?"?":"&";
        newUrl= url + separator + newParam;
      }else{
        oldParam= new URL(url);
        oldParam = oldParam.searchParams.get("currency");
        newParam= $(this).val();
        newUrl=url.replace(oldParam,newParam);
      }
      $("input[name=current_currency]").val($( "select.currency-picker" ).val());
      // window.location.href =newUrl;
      $('#CartDrawer').attr('data-fetch', 0);
    });

    $("body").on("click", ".cart__remove", function() {
      $('#CartTemplate').addClass('is-loading');
      $.ajax({
        type: 'POST',
        url: '/cart/remove_item_quantity',
        data: {
          variant_id: $(this).data( "variant-id"),
          item_id: $(this).data( "item-id"),
          quantity: $(this).data( "quantity"),
          i_id: $(this).data("i_id"),
        },
        dataType: 'json',
        success: function(response){

          theme.cartDrawer(response);
          $('#CartTemplate').removeClass('is-loading');
        },
        error: function(xhr){
          console.log('error',xhr);
          $('#CartTemplate').removeClass('is-loading');
        }
      });

    });


    $('body').on("click", "#applycode",function() {
      
      if($("input[name='voucher_code']").val() != '') {

        $('#CartTemplate').addClass('is-loading');

        $.ajax({
          type: 'POST',
          url: '/new_cart/voucher',
          data: {
            voucher_code: $("input[name='voucher_code']").val(),
            category: 'create'
          },
          dataType: 'json',
          success: function(response){

            // console.log(response);

            if(response.error != undefined){
              
              if(response.error.message != undefined) popToast(response.error.message); 
            
              $("input[name='voucher_code']").val('')
            
            } else {
            
              theme.cartDrawer(response);
              
            }
            $('#CartTemplate').removeClass('is-loading');
            
          },
          error: function(xhr){
            console.log('error',xhr);
            $('#CartTemplate').removeClass('is-loading');
          }
        });

      }

    });


    $("body").on("click", ".remove_voucher_btn", function() {
          $('#CartTemplate').addClass('is-loading');
          $.ajax({
            type: 'DELETE',
            url: '/new_cart/voucher',
            data: {
              category: 'remove',
              order_discount_id: $(this).data( "discount-id")
            },
            dataType: 'json',
            success: function(data){
              // console.log(data);
              theme.cartDrawer(data);
              $('#CartTemplate').removeClass('is-loading');
            },
            error: function(xhr){
              console.log('error',xhr);
              $('#CartTemplate').removeClass('is-loading');
            }
          });

      });
    

    theme.cartDrawer = function(data){
      
        $('#CartDrawer').attr('data-fetch', 1);
        $('#CartTemplate').addClass('is-loading');

        
        if(typeof data.cart_content  == 'string'){
          $('#CartTemplate').html(data.cart_content);
        }

        let cart_item_count = data.item_count || data.cart.item_count;

        if(cart_item_count > 0){
          $('.cart-count').removeClass('hidden-count');
        }else{
          $('.cart-count').addClass('hidden-count');
        }

        $('.cart-count').text(cart_item_count);
        $('#CartTemplate').removeClass('is-loading');
        $(".cart-drawer-content").animate({ scrollTop: 0 });

        if(window.EasyStore != undefined && window.EasyStore.Promotion != undefined && window.EasyStore.Promotion.updateCartPromotion != undefined) window.EasyStore.Promotion.updateCartPromotion()

    }

    theme.fetchCartDrawer = function(data){
        $('#CartTemplate').addClass('is-loading');
        $.ajax({
          url: '/new_cart?retrieve=true',
          type: 'GET',
          success: function(data, status) {
            // console.log(data);
            theme.cartDrawer(data);

            $('#CartTemplate').removeClass('is-loading');
          },
          error: function(XMLHttpRequest, textStatus) {
            console.log('error',XMLHttpRequest,textStatus);
            $('#CartTemplate').removeClass('is-loading');
          }
        });
    }

    theme.updateCartDrawer = function(data){
      $('#CartTemplate').addClass('is-loading');

      $.ajax({
        url: '/new_cart/update',
        type: 'PUT',
        dataType: 'json',
        data: $('#CartDrawer form').serialize(),
        success: function(data, status) {
          theme.cartDrawer(data);
        },
        error: function(XMLHttpRequest, textStatus) {
          console.log('error',XMLHttpRequest,textStatus);
        }
      });
    }

    function debounce(func, wait, immediate) {
      var timeout;
      return function() {
          var context = this, args = arguments;
          var later = function() {
              timeout = null;
              if (!immediate) func.apply(context, args);
          };
          var callNow = immediate && !timeout;
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
          if (callNow) func.apply(context, args);
      };
    };

    $('body').on("change", 'input.cart__quantity-selector', function (){
      theme.updateCartDrawer();
    });


    $('#updateCartDrawer').click(function() {
      theme.updateCartDrawer();
    });

    $('body').on("click", ".btn-qty-adjust", function() {

      var $button = $(this);
      var oldValue = $button.parent().find("input.cart__quantity-selector").val();

      if ($button.attr('data-adjust') == 1) {
        var newVal = parseFloat(oldValue) + 1;
      } else {
      // Don't allow decrementing below zero
        if (oldValue > 0) {
          var newVal = parseFloat(oldValue) - 1;
        } else {
          newVal = 0;
        }
      }

      $button.parent().find("input").val(newVal);
    });
      
    $('body').on("click", ".btn-qty-adjust", debounce(function() {
      theme.updateCartDrawer();
    },350));

    $('button.checkout').click(function() {
      $(this).addClass('btn--loading');
    });

    var add_cart_success_html = '<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"> <g> <g> <path d="M383.841,171.838c-7.881-8.31-21.02-8.676-29.343-0.775L221.987,296.732l-63.204-64.893 c-8.005-8.213-21.13-8.393-29.35-0.387c-8.213,7.998-8.386,21.137-0.388,29.35l77.492,79.561 c4.061,4.172,9.458,6.275,14.869,6.275c5.134,0,10.268-1.896,14.288-5.694l147.373-139.762 C391.383,193.294,391.735,180.155,383.841,171.838z"/> </g> </g> <g> <g> <path d="M256,0C114.84,0,0,114.84,0,256s114.84,256,256,256s256-114.84,256-256S397.16,0,256,0z M256,470.487 c-118.265,0-214.487-96.214-214.487-214.487c0-118.265,96.221-214.487,214.487-214.487c118.272,0,214.487,96.221,214.487,214.487 C470.487,374.272,374.272,470.487,256,470.487z"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>';
        add_cart_success_html += '{{ "products.product.added_to_cart" | t }} <br><a class="CartDrawerTrigger">{{ "products.product.view_cart" | t }}</a>';

    function popToast(content) {
      var x = document.getElementById("toast"),
          y = document.getElementById("toastContent");

      y.innerHTML = content;
      x.className += " show";
      
      var hideToast = setTimeout(function(){ x.className = x.className.replace(" show", ""); }, 3000);
    }

  </script>

{% else %}

  <div id="CartDrawer" class="cart-drawer" data-fetch="0">
    <form action="/cart" method="post" novalidate class="cart">
      <div class="cart-drawer-wrapper">
        {% comment %}
        
          This is your /cart template.
        
        {% endcomment %}
        {% app_snippet 'cart/content_top' %}

        
        <div id="hasCartItem" {% if cart.item_count < 1 %}style="display: none;"{% endif %} >

            <input type="hidden" name="_token" value="{% csrf %}">
        
        
          <div class="cart-drawer-content">
              <div class="cart-drawer-content-wrapper">
                
                  <div class="section-header">
                    <div class="section-header__title h2">{{ 'cart.general.title' | t }}</div>
                    <span class="CartDrawerTrigger icon icon-x"></span>
                  </div>
                  
                {% if cart.announcements.size > 0 %}
                  <ul class="note">
                    {% for announcement in cart.announcements %}
                      <li>{{ announcement }}</li>
                    {% endfor %}
                  </ul>
                {% endif %}
                    
                <div class='currency_country'></div>
                    
                            <div id="cartDrawerError">
                              {% if cart.errors.size > 0 %}
                                <ul class="note errors">
                                  {% for error in cart.errors %}
                                    <li>{{ error }}</li>
                                  {% endfor %}
                                </ul>
                              {% endif %}
                            </div>
                    
                    
                {% comment %}
                  Loop through products in the cart
                {% endcomment %}
                            <div class="cart__row-wrapper">
                              {% for item in cart.items %}
                                <div class="cart__row">

                                  {% if item.promotion_id %}
                                    <div class="cart__row">
                                      <div class="promotion__wrapper">
                                        <div class="promotion__title">
                                          <div class="promotion__badge">
                                            <div class="promotion__badge-text">{{ item.title }}</div>
                                          </div>
                                        </div>
                                        {% for i in item.items %}
                                          <div class="grid--full">
                                            <div class="grid__item large--one-whole">
                                              <div class="order-item-wrapper">
                                                <div class="order-item-img">
                                                  <a href="{{ i.url | within: collections.all }}" class="cart__image">
                                                    <img src="{{ i | img_url: 'medium' }}" alt="{{ i.title | escape }}">
                                                  </a>
                                                </div>
                                                <div class="order-item-detail">
                                                  <a href="{{ i.url }}" class="h5">
                                                    {{ i.product.title }}
                                                  </a>

                                                  {% unless i.variant.title contains 'Default' %}
                                                    <br>
                                                    <small>{{ i.variant.title }}</small>
                                                  {% endunless %}

                                                  <div>
                                                          {% if i.original_price != i.price %}
                                                          <small class="cart-item__original-price"><s>{{cart.currency}} {{ i.original_price }}</s></small><br>
                                                          {% endif %}
                                                          {{cart.currency}} {{ i.price }}
                                                  </div>

                                                  {% assign propertySize = i.properties | size %}
                                                  {% if propertySize > 0 %}
                                                    {% for p in i.properties %}
                                                      {% unless p.last == blank %}
                                                        {{ p.first }}:

                                                        {% comment %}
                                                          Check if there was an uploaded file associated
                                                        {% endcomment %}
                                                        {% if p.last contains '/uploads/' %}
                                                          <a href="{{ p.last }}">{{ p.last | split: '/' | last }}</a>
                                                        {% else %}
                                                          {{ p.last }}
                                                        {% endif %}

                                                        <br>
                                                      {% endunless %}
                                                    {% endfor %}
                                                  {% endif %}

                                                  {% if i.freebie != true %}
                                                    <a class="cart__remove" data-variant-id="{{i.variant.id}}" data-quantity="{{i.quantity}}">
                                                      <small>
                                                        <svg class="svg-icon" id="Es_1" data-name="Es 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 486.4 486.4"><path d="M443.33,72.28H343.46V56A52.85,52.85,0,0,0,290.67,3.2H195.73A52.85,52.85,0,0,0,142.94,56V72.28H43.07a13.32,13.32,0,1,0,0,26.64H67.15V412A71.34,71.34,0,0,0,138.4,483.2H348A71.34,71.34,0,0,0,419.25,412v-313h24.08a13.32,13.32,0,0,0,0-26.64ZM169.58,56a26.2,26.2,0,0,1,26.15-26.16h94.94A26.21,26.21,0,0,1,316.82,56V72.28H169.58Zm223,356A44.69,44.69,0,0,1,348,456.56H138.4A44.7,44.7,0,0,1,93.79,412v-313H392.71V412Z"/><path d="M243.2,398.59a12.23,12.23,0,0,0,12.29-12.28V169.11a12.29,12.29,0,0,0-24.58,0v217.1A12.31,12.31,0,0,0,243.2,398.59Z"/><path d="M157.46,398.59a13.77,13.77,0,0,0,13.83-13.83V170.65a13.84,13.84,0,0,0-27.67,0V384.76A13.84,13.84,0,0,0,157.46,398.59Z"/><path d="M328.94,398.59a13.77,13.77,0,0,0,13.84-13.83V170.65a13.84,13.84,0,0,0-27.67,0V384.76A13.77,13.77,0,0,0,328.94,398.59Z"/></svg>
                                                      </small>
                                                    </a>
                                                  {% endif %}

                                                  {% if i.message.size > 0 %}
                                                  <div class="grid grid--full">
                                                    {% for m in i.message %}
                                                      <div class="h5 grid--full promotion-suggestion">
                                                        {% assign label_message = 'cart.label.' | append: m.display_title %} 
                                                        {{ label_message | t }}
                                                      </div>
                                                    {% endfor %}
                                                  </div>
                                                  {% endif %}

                                                </div>
                                              </div>
                                            </div>
                                            <div class="grid__item large--one-whole">
                                              <div class="grid--full">

                                                <div class="grid__item one-half text-left">
                                                  
                                                  {% if i.freebie != true %}
                                                  <div class="cart-qty-adjust">
                                                    <a class="input-group-btn btn-qty-adjust btn" data-adjust="0">
                                                      -
                                                    </a>
                                                    <input type="number" class="cart__quantity-selector" name="updates[]" id="updates_{{ i.variant.id }}" value="{{ i.quantity }}" min="0">
                                                    <a class="input-group-btn btn-qty-adjust btn" data-adjust="1">
                                                      +
                                                    </a>
                                                  </div>
                                                  <input type="hidden" name="ids[]" value="{{ i.variant.id }}">
                                                  {% else %}
                                                  <input type="number" class="cart__quantity-selector" value="{{i.quantity}}" disabled="disabled" style="background: transparent; border-color: transparent;">
                                                  {% endif %}
                                                </div>
                                                <div class="grid__item one-half text-right">
                                                  
                                                  <span class="h5">
                                                    {% if i.original_line_price != i.line_price %}
                                                      <small class="cart-item__original-price"><s>{{cart.currency}} {{ i.original_line_price }}</s></small>
                                                    {% endif %}
                                                    {{cart.currency}} {{ i.line_price }}
                                                  </span>

                                                  {% comment %}
                                                  {% if i.original_line_price != i.line_price %}
                                                    {% for discount in i.discounts %}
                                                      <small class="cart-item__discount">
                                                        {{ discount.title }}
                                                      </small>
                                                    {% endfor %}
                                                  {% endif %}
                                                  {% endcomment %}

                                                </div>
                                              </div>
                                            </div>
                                          </div>
                                        {% endfor %}

                                        {% if item.discount_amount > 0 %}
                                        <div class="grid--full">
                                          <div class="grid__item large--one-whole">
                                            <div class="grid text-right">
                                              <span class="grid__item h5 large--five-eighths"><b>{{ 'checkout.general.discount' | t }}</b></span>
                                              <span class="grid__item h5 large--three-eighths">- {{cart.currency}} {{ item.discount_amount }}</span>
                                            </div>
                                          </div>
                                        </div>
                                        {% endif %}

                                      </div>
                                    </div>

                                  {% else %}

                                  <div class="grid--full">

                                    <div class="grid__item large--one-whole">
                                      <div class="order-item-wrapper">

                                        <div class="order-item-img">
                                          <a href="{{ item.url | within: collections.all }}" class="cart__image">
                                            <img src="{{ item | img_url: 'medium' }}" alt="{{ item.title | escape }}">
                                          </a>
                                        </div>

                                        <div class="order-item-detail">
                                          <a href="{{ item.url }}" class="h5">
                                            {{ item.product.title }}
                                          </a>
                                          {% unless item.variant.title contains 'Default' %}
                                            <br>
                                            <small>{{ item.variant.title }}</small>
                                          {% endunless %}

                                          <div>
                                                  {% if item.original_price != item.price %}
                                                  <small class="cart-item__original-price"><s>{{cart.currency}} {{ item.original_price }}</s></small><br>
                                                  {% endif %}
                                                  {{cart.currency}} {{ item.price }}
                                          </div>

                                          {% comment %}
                                            <p>{{ item.vendor }}</p>
                                          {% endcomment %}

                                          {% comment %}
                                            Optional, loop through custom product line items if available
                                          {% endcomment %}
                                          {% assign propertySize = item.properties | size %}
                                          {% if propertySize > 0 %}
                                            {% for p in item.properties %}
                                              {% unless p.last == blank %}
                                                {{ p.first }}:

                                                {% comment %}
                                                  Check if there was an uploaded file associated
                                                {% endcomment %}
                                                {% if p.last contains '/uploads/' %}
                                                  <a href="{{ p.last }}">{{ p.last | split: '/' | last }}</a>
                                                {% else %}
                                                  {{ p.last }}
                                                {% endif %}

                                                <br>
                                              {% endunless %}
                                            {% endfor %}
                                          {% endif %}


                                          <a class="cart__remove" data-variant-id="{{item.variant.id}}" data-quantity="{{item.quantity}}">
                                            <small>
                                              <svg class="svg-icon" id="Es_1" data-name="Es 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 486.4 486.4"><path d="M443.33,72.28H343.46V56A52.85,52.85,0,0,0,290.67,3.2H195.73A52.85,52.85,0,0,0,142.94,56V72.28H43.07a13.32,13.32,0,1,0,0,26.64H67.15V412A71.34,71.34,0,0,0,138.4,483.2H348A71.34,71.34,0,0,0,419.25,412v-313h24.08a13.32,13.32,0,0,0,0-26.64ZM169.58,56a26.2,26.2,0,0,1,26.15-26.16h94.94A26.21,26.21,0,0,1,316.82,56V72.28H169.58Zm223,356A44.69,44.69,0,0,1,348,456.56H138.4A44.7,44.7,0,0,1,93.79,412v-313H392.71V412Z"/><path d="M243.2,398.59a12.23,12.23,0,0,0,12.29-12.28V169.11a12.29,12.29,0,0,0-24.58,0v217.1A12.31,12.31,0,0,0,243.2,398.59Z"/><path d="M157.46,398.59a13.77,13.77,0,0,0,13.83-13.83V170.65a13.84,13.84,0,0,0-27.67,0V384.76A13.84,13.84,0,0,0,157.46,398.59Z"/><path d="M328.94,398.59a13.77,13.77,0,0,0,13.84-13.83V170.65a13.84,13.84,0,0,0-27.67,0V384.76A13.77,13.77,0,0,0,328.94,398.59Z"/></svg>
                                            </small>
                                          </a>

                                          {% if item.message.size > 0 %}
                                          <div class="grid grid--full">
                                            {% for m in item.message %}
                                            <div class="h5 grid--full promotion-suggestion promotion-popup-button" id="promotion-suggestion-{{m.id}}" data-promotion="{{m.id}}" data-promotion-type="{{m.r_discount_type_id}}" data-promotion-name="{{m.display_title}}">
                                              {{ m.display_title }}
                                            </div>
                                            {% endfor %}
                                          </div>
                                          {% endif %}

                                        </div>

                                      </div>
                                    </div>

                                    <div class="grid__item large--one-whole">
                                      <div class="grid--full">



                                        <div class="grid__item one-half text-left">
                                          <div class="cart-qty-adjust">
                                            <a class="input-group-btn btn-qty-adjust btn" data-adjust="0">
                                              -
                                            </a>
                                            <input type="number" class="cart__quantity-selector" name="updates[]" id="updates_{{ item.variant.id }}" value="{{ item.quantity }}" min="0">
                                            <a class="input-group-btn btn-qty-adjust btn" data-adjust="1">
                                              +
                                            </a>
                                          </div>
                                          <input type="hidden" name="ids[]" value="{{ item.variant.id }}">
                                        </div>

                                        <div class="grid__item one-half text-right">
                                          
                                          <span class="h5">
                                            {% if item.original_line_price != item.line_price %}
                                              <small class="cart-item__original-price"><s>{{cart.currency}} {{ item.original_line_price }}</s></small>
                                            {% endif %}
                                            {{cart.currency}} {{ item.line_price }}
                                          </span>
                                          {% if item.original_line_price != item.line_price %}
                                            {% for discount in item.discounts %}
                                              <small class="cart-item__discount">
                                                {{ discount.title }}
                                              </small>
                                            {% endfor %}
                                          {% endif %}
                                        </div>

                                      </div>
                                    </div>

                                  </div>

                                  {% endif %}
                                </div>
                              {% endfor %}
                            </div>
                    
                {% if cart.discounts.size > 0 %}
                <div class="cart-additional-savings text-right cart__row">
                  <span class="label cart-additional-savings__label">{{ 'cart.general.additional_savings' | t }}</span>
                  <span class="h5 cart-additional-savings__price">{{cart.currency}} {{ cart.discount.total_savings }}</span>
                  {% for discount in cart.discounts %}
                    <small class="cart-additional-savings__savings">{{ discount.title }}</small>
                  {% endfor %}
                </div>
                {% endif %}
                    
                <div class="cart__row subtotal-section">
                  <div class="grid">
                    {% comment %}
                      Optional, add a textarea for special notes
                        - Your theme settings can turn this on or off. Default is on.
                        - Make sure you have name="note" for the message to be submitted properly
                    {% endcomment %}
                    {% if settings.cart_notes_enable %}
                      {% assign noteSize = cart.note | size %}
                      <div class="grid__item large--five-twelfths">
                        <button type="button" class="text-link cart__note-add{% if noteSize > 0 %} is-hidden{% endif %}">
                          {{ 'cart.label.add_note' | t }}
                        </button>
                        <div class="cart__note{% if noteSize > 0 %} is-active{% endif %}">
                          <label for="CartSpecialInstructions">{{ 'cart.general.note' | t }}</label>
                          <textarea name="note" class="input-full" id="CartSpecialInstructions">{{ cart.note }}</textarea>
                        </div>
                      </div>
                    {% endif %}
                    <div class="grid__item text-right{% if settings.cart_notes_enable %} large--seven-twelfths{% endif %}">
                      <div id="cart_storewide-discounts">
                        {% for storewide in cart.storewide_discounts %}
                          {% if storewide.display == empty or storewide.display != false %}
                          <p>
                            <span class="cart__subtotal-title">{{storewide.display_title}}</span>
                            <span class="h5 cart__subtotal">{{cart.currency}} {{ storewide.amount }}</span>
                          </p>
                          {% endif %}
                        {% endfor %}
                      </div>
                    
                      <div id="cart__voucher-section">
                        {% for voucher in cart.voucher_discounts %}
                          <div class="voucher_info">
                              <span class="cart__subtotal-title">{{voucher.display_title}} - {{voucher.voucher_code}} 
                                <small><a id="remove_voucher" data-discount-id="{{voucher.id}}">({{ 'cart.general.remove' | t }})</a></small>
                              </span>
                              {% if voucher.amount != null %}
                                <span class="h5 cart__subtotal">{{cart.currency}} {{ voucher.amount }}</span>
                              {% endif %}
                              {% if voucher.shipping_method %}
                                <div>
                                  <small class="voucher_info-tooltip">
                                    <svg class="svg-icon" width="14px" id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,9.58a1,1,0,0,0-1,1v8a1,1,0,0,0,2,0v-8A1,1,0,0,0,12,9.58Z"/><circle cx="12" cy="6.8" r="1.48"/><path d="M12,.85A11.15,11.15,0,1,0,23.15,12,11.16,11.16,0,0,0,12,.85Zm0,21A9.85,9.85,0,1,1,21.85,12,9.86,9.86,0,0,1,12,21.85Z"/></svg>
                                    {{ 'cart.general.voucher_message_shipping_only' | t }}
                                    <span class="voucher_info-tooltip-content">
                                    {% for x in voucher.shipping_method %}
                                      <span>{{x}}</span>
                                    {% endfor %}
                                    </span>
                                  </small>
                                </div>
                              {% endif %}
                              {% if voucher.payment_method %}
                                <div>
                                  <small class="voucher_info-tooltip">
                                    <svg class="svg-icon" width="14px" id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,9.58a1,1,0,0,0-1,1v8a1,1,0,0,0,2,0v-8A1,1,0,0,0,12,9.58Z"/><circle cx="12" cy="6.8" r="1.48"/><path d="M12,.85A11.15,11.15,0,1,0,23.15,12,11.16,11.16,0,0,0,12,.85Zm0,21A9.85,9.85,0,1,1,21.85,12,9.86,9.86,0,0,1,12,21.85Z"/></svg>
                                    {{ 'cart.general.voucher_message_payment_only' | t }}
                                    <span class="voucher_info-tooltip-content">
                                    {% for x in voucher.payment_method %}
                                      <span>{{x}}</span>
                                    {% endfor %}
                                    </span>
                                  </small>
                                </div>
                              {% endif %}
                          </div>
                        {% endfor %}
                      </div>

                      <p>
                        <span class="cart__subtotal-title">{{ 'cart.general.subtotal' | t }}</span>
                        <span id="cartSubtotal" class="h5 cart__subtotal">{{cart.currency}} {{ cart.total_price }}</span>
                        {% if cart.total_discounts > 0 %}
                          {% assign savings = cart.total_discounts %}
                          <small class="cart-subtotal__savings">{{cart.currency}} {{ 'cart.general.savings_html' | t: savings }}</small>
                        {% endif %}
                      </p>
                      
                      
                      {% for voucher in cart.shipping_discount %}
                        <div class="voucher_info">
                            <span class="cart__subtotal-title">{{voucher.display_title}} - {{voucher.voucher_code}} 
                              <small><a id="remove_voucher" data-discount-id="{{voucher.order_discount_id}}">({{ 'cart.general.remove' | t }})</a></small>
                            </span>
                            {% if voucher.amount != null %}
                              <span class="h5 cart__subtotal">{{cart.currency}} {{ voucher.amount }}</span>
                            {% endif %}
                            {% if voucher.shipping_method %}
                              <div>
                                <small class="voucher_info-tooltip">
                                  <svg class="svg-icon" width="14px" id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,9.58a1,1,0,0,0-1,1v8a1,1,0,0,0,2,0v-8A1,1,0,0,0,12,9.58Z"/><circle cx="12" cy="6.8" r="1.48"/><path d="M12,.85A11.15,11.15,0,1,0,23.15,12,11.16,11.16,0,0,0,12,.85Zm0,21A9.85,9.85,0,1,1,21.85,12,9.86,9.86,0,0,1,12,21.85Z"/></svg>
                                  {{ 'cart.general.voucher_message_shipping_only' | t }}
                                  <span class="voucher_info-tooltip-content">
                                  {% for x in voucher.shipping_method %}
                                    <span>{{x}}</span>
                                  {% endfor %}
                                  </span>
                                </small>
                              </div>
                            {% endif %}
                            {% if voucher.pickup_location %}
                              <div>
                                <small class="voucher_info-tooltip">
                                  <svg class="svg-icon" width="14px" id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,9.58a1,1,0,0,0-1,1v8a1,1,0,0,0,2,0v-8A1,1,0,0,0,12,9.58Z"/><circle cx="12" cy="6.8" r="1.48"/><path d="M12,.85A11.15,11.15,0,1,0,23.15,12,11.16,11.16,0,0,0,12,.85Zm0,21A9.85,9.85,0,1,1,21.85,12,9.86,9.86,0,0,1,12,21.85Z"/></svg>
                                  {{ 'cart.general.voucher_message_pickup_only' | t }}
                                  <span class="voucher_info-tooltip-content">
                                  {% for x in voucher.pickup_location %}
                                    <span>{{x}}</span>
                                  {% endfor %}
                                  </span>
                                </small>
                              </div>
                            {% endif %}
                            {% if voucher.zone %}
                              <div>
                                <small class="voucher_info-tooltip">
                                  <svg class="svg-icon" width="14px" id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,9.58a1,1,0,0,0-1,1v8a1,1,0,0,0,2,0v-8A1,1,0,0,0,12,9.58Z"/><circle cx="12" cy="6.8" r="1.48"/><path d="M12,.85A11.15,11.15,0,1,0,23.15,12,11.16,11.16,0,0,0,12,.85Zm0,21A9.85,9.85,0,1,1,21.85,12,9.86,9.86,0,0,1,12,21.85Z"/></svg>
                                  {{ 'cart.general.voucher_message_zone_only' | t }}
                                  <span class="voucher_info-tooltip-content">
                                  {% for x in voucher.zone %}
                                    <span>{{x}}</span>
                                  {% endfor %}
                                  </span>
                                </small>
                              </div>
                            {% endif %}
                        </div>
                      {% endfor %}
                    
                      <div id="promotion__code-input-wrapper">
                        {% if cart.active_voucher_promotion == true %}
                          {% if cart.voucher_discounts == empty or cart.multiple_voucher_enabled == true %}
                            <p class="promotion__code-input">
                              <span class="input-group">
                                <input type="text" class="input-group-field" name="voucher_code" placeholder="{{ 'checkout.general.discount_code' | t }}">
                                <span class="input-group-btn">
                                  <input type="button" class="btn" value="{{ 'checkout.general.apply' | t }}" name="apply" id="applycode">
                                </span>
                              </span>
                            </p>
                          {% endif %}
                        {% endif %}
                      </div>
                    
                      <p><em>{{ 'cart.general.shipping_at_checkout' | t }}</em></p>
                      <input type="hidden" name="current_currency" value="{{cart.currency}}">
                      {% comment %}<a name="update" id="updateCartDrawer" class="btn--secondary update-cart">{{ 'cart.general.update' | t }}</a>{% endcomment %}
                      
                    
                      
                    
                      {% if additional_checkout_buttons %}
                          <div class="cart__additional_checkout">{{ content_for_additional_checkout_buttons }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>

              <div class="cart-sticky-button">
                {% if shop.plan_id == "0" or shop.plan_id == "5" or shop.plan_id == "6" %}
                  {% if shop.express_enabled %}
                    <a id="express-checkout-btn_sidebar" class="btn checkout">{{ 'cart.general.checkout' | t }}  <svg class="svg-icon" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 493.356 493.356" xml:space="preserve"> <g> <path d="M490.498,239.278l-109.632-99.929c-3.046-2.474-6.376-2.95-9.993-1.427c-3.613,1.525-5.427,4.283-5.427,8.282v63.954H9.136 c-2.666,0-4.856,0.855-6.567,2.568C0.859,214.438,0,216.628,0,219.292v54.816c0,2.663,0.855,4.853,2.568,6.563 c1.715,1.712,3.905,2.567,6.567,2.567h356.313v63.953c0,3.812,1.817,6.57,5.428,8.278c3.62,1.529,6.95,0.951,9.996-1.708 l109.632-101.077c1.903-1.902,2.852-4.182,2.852-6.849C493.356,243.367,492.401,241.181,490.498,239.278z"/> </g> </svg>
                  </a>
                  {% else %}
                    <button type="submit" name="checkout" class="btn checkout">
                      {{ 'cart.general.checkout' | t }}
                      <svg class="svg-icon" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 493.356 493.356" xml:space="preserve"> <g> <path d="M490.498,239.278l-109.632-99.929c-3.046-2.474-6.376-2.95-9.993-1.427c-3.613,1.525-5.427,4.283-5.427,8.282v63.954H9.136 c-2.666,0-4.856,0.855-6.567,2.568C0.859,214.438,0,216.628,0,219.292v54.816c0,2.663,0.855,4.853,2.568,6.563 c1.715,1.712,3.905,2.567,6.567,2.567h356.313v63.953c0,3.812,1.817,6.57,5.428,8.278c3.62,1.529,6.95,0.951,9.996-1.708 l109.632-101.077c1.903-1.902,2.852-4.182,2.852-6.849C493.356,243.367,492.401,241.181,490.498,239.278z"/> </g> </svg>
                    </button>
                  {% endif %}
        
                {% else %}
                    <button type="submit" name="checkout" class="btn checkout">
                      {{ 'cart.general.checkout' | t }}
                      <svg class="svg-icon" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 493.356 493.356" xml:space="preserve"> <g> <path d="M490.498,239.278l-109.632-99.929c-3.046-2.474-6.376-2.95-9.993-1.427c-3.613,1.525-5.427,4.283-5.427,8.282v63.954H9.136 c-2.666,0-4.856,0.855-6.567,2.568C0.859,214.438,0,216.628,0,219.292v54.816c0,2.663,0.855,4.853,2.568,6.563 c1.715,1.712,3.905,2.567,6.567,2.567h356.313v63.953c0,3.812,1.817,6.57,5.428,8.278c3.62,1.529,6.95,0.951,9.996-1.708 l109.632-101.077c1.903-1.902,2.852-4.182,2.852-6.849C493.356,243.367,492.401,241.181,490.498,239.278z"/> </g> </svg>
                    </button>
                {% endif %}
              </div>
            </div>

        
            
        
          
        
          <script type="text/javascript">
            $("input[name=current_currency]").val($( "select.currency-picker" ).val());
            $( "select.currency-picker" ).change(function(){
              $("select.currency-picker").val($(this).val());
              url=window.location.href;
              newParam="currency=" + $( "select.currency-picker" ).val();
              if(url.indexOf("currency=")===-1){
                separator = (url.indexOf("?")===-1)?"?":"&";
                newUrl= url + separator + newParam;
              }else{
                oldParam= new URL(url);
                oldParam = oldParam.searchParams.get("currency");
                newParam= $(this).val();
                newUrl=url.replace(oldParam,newParam);
              }
              $("input[name=current_currency]").val($( "select.currency-picker" ).val());
              // window.location.href =newUrl;
              $('#CartDrawer').attr('data-fetch', 0);
            });
        
              $("body").on("click", ".cart__remove", function() {
                $('#CartDrawer #hasCartItem').addClass('is-loading');
                $.ajax({
                  type: 'POST',
                  url: '/cart/remove_item_quantity?retrieve=true',
                  data: {
                    variant_id: $(this).data( "variant-id"),
                    quantity: $(this).data( "quantity"),
                    i_id: $(this).data("i_id"),
                  },
                  dataType: 'json',
                  success: function(response){

                    // console.log(response);
                    theme.cartDrawer(response);
                    $('#CartDrawer #hasCartItem').removeClass('is-loading');
                  },
                  error: function(xhr){
                    location.reload();
                  }
                });
        
              });
        
        
              $('body').on("click", "#applycode",function() {
                
                if($("input[name='voucher_code']").val() != '') {

                  $('#CartDrawer #hasCartItem').addClass('is-loading');

                  $.ajax({
                    type: 'POST',
                    url: '/cart/apply_cart_voucher_code?retrieve=true',
                    data: {
                      voucher_code: $("input[name='voucher_code']").val(),
                      category: 'create'
                    },
                    dataType: 'json',
                    success: function(response){
        
                      // console.log(response);

                      if(response.item_count != undefined){
                        
                        theme.cartDrawer(response);
                        $('#CartDrawer #hasCartItem').removeClass('is-loading');

                      } else {

                        $('#CartDrawer #hasCartItem').removeClass('is-loading');

                        if(response.errors.Voucher_Code_Invalid){
        
                          popToast(response.errors.Voucher_Code_Invalid);
          
                        }
        
                        if(response.errors.Voucher_Code_Exists){
        
                          popToast(response.errors.Voucher_Code_Exists);
          
                        }
        
                        $("input[name='voucher_code']").val('')
        
                      }
                    },
                    error: function(xhr){
                      location.reload();
                    }
                  });
        
                }
        
              });
        
        
              $("body").on("click", "#remove_voucher", function() {
                  $('#CartDrawer #hasCartItem').addClass('is-loading');
                  $.ajax({
                    type: 'POST',
                    url: '/cart/apply_cart_voucher_code?retrieve=true',
                    data: {
                      category: 'remove',
                      order_discount_id: $(this).data( "discount-id")
                    },
                    dataType: 'json',
                    success: function(data){
                      // console.log(data);
                      theme.cartDrawer(data);
                      $('#CartDrawer #hasCartItem').removeClass('is-loading');
                    },
                    error: function(xhr){
                      location.reload();
                    }
                  });
        
              });
            
          </script>
          
        </div>
        
        <div id="noCartItem" class="cart-drawer-content" {% if cart.item_count > 0 %}style="display: none;"{% endif %}>
            <div class="cart-drawer-content-wrapper">
                {% comment %}
                  The cart is empty
                {% endcomment %}
                <div class="section-header">
                  <div class="section-header__title h2">{{ 'cart.general.title' | t }}</div>
                  <span class="CartDrawerTrigger icon icon-x"></span>
                </div>
                <div>{{ 'cart.general.empty' | t }}</div>
                <div>{{ 'cart.general.continue_browsing_html' | t }}</div>
          </div>
        </div>
        
        
        {% app_snippet 'cart/content_bottom' %}
      </div>

      {% if shop.plan_id == "0" or shop.plan_id == "5" or shop.plan_id == "6" %}
        {% if shop.express_enabled %}
          {% comment %}
          Express checkout dialog 
          {% endcomment %}
          <div id="express-checkout-dialog_sidebar" class="modal__dialog">
            <div class="modal__dialog-bg dialog__close-toggle"></div>
            <div class="modal__dialog-wrapper small__dialog">
              <span class="dialog__close dialog__close-toggle">Ã—</span>
              <div class="modal__dialog-content">
                <div class="modal__dialog-express-checkout">
                  <div>
                    <button type="submit" name="expresscheckout" class="btn btn--full checkout">{{ 'cart.general.express_checkout' | t }}</button>
                  </div>
                  <div>
                    {{ 'cart.general.or' | t }}
                  </div>
                  <div class="text-center">
                    <button type="submit" name="checkout" class="btn btn--full btn--tertiary checkout">{{ 'cart.general.standard_checkout' | t }}</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <script type="text/javascript">
            $( "#express-checkout-btn_sidebar" ).click(function() {
              var scrollbarWidth = window.innerWidth - document.body.clientWidth;
              $('#express-checkout-dialog_sidebar').addClass('show');
              $('html').css({'overflow': 'hidden','margin-right': scrollbarWidth});
            }
            );
            $( ".dialog__close-toggle" ).click(function() {
              $('#express-checkout-dialog_sidebar').removeClass('show');
              $('html').css({'overflow': '','margin-right': ''});
            });
            $( "button.btn.checkout" ).click(function() {
              $(this).addClass("btn--loading");
            }
            );
          </script>
        {% endif %}
      {% endif %}
    </form>
  </div>
  <div id="toast"><div id="toastContent"></div></div>
  
  <style>
    #toastContent a{color: #fff;text-decoration: underline;margin-top: 10px;display: block;}
    #toastContent .svg-icon{margin-right: 8px;margin-top: -1px;}
  </style>

  <script>

  theme.cartDrawer = function(data){
      var money_prefix = '',
          money_suffix = '';
      if(data.item_count > 0){
        var currency_format = Currency[Currency.format][data.currency].split(new RegExp(/\{\{.+?\}\}/));
          money_prefix = currency_format[0],
          money_suffix = currency_format[1];
      }
    
      $('#CartDrawer #hasCartItem').addClass('is-loading');

      $('#CartDrawer').attr('data-fetch', 1);
    
      $('#cartDrawerError').empty();
      $('#CartDrawer .cart__row-wrapper').empty();

      var cart__html = '';

      if(data.item_count > 0){
        $('#hasCartItem').show();
        $('#noCartItem').hide();

        // Cart item > 0
        $.each(data.items, function( index, a ) {

          if(a.promotion_id != undefined){

            cart__html += '<div class="cart__row"> <div class="promotion__wrapper"> <div class="promotion__title"> <div class="promotion__badge"> <div class="promotion__badge-text">'+ a.title +'</div> </div> </div>';

            $.each(a.items, function( index, b ) {
              cart__html += '<div class="grid--full"> <div class="grid__item large--one-whole"> <div class="order-item-wrapper"> <div class="order-item-img"> <a href="/'+ b.url+'" class="cart__image"> <img src="'+b.img_url+'" alt="'+b.product.title+'"> </a> </div> <div class="order-item-detail"> <a href="/'+ b.url+'" class="h5"> '+b.product.title+'</a>'; 

            // Variant name
            if(b.variant.title != "Default Tile"){
              cart__html += '<br><small>'+b.variant.title+'</small>';
            }

            if(b.properties && b.properties.length > 0){
              $.each(b.properties, function(index, property){
                  cart__html += '<br><small>'+property.first+': '+'</small><small>'+property.last+'</small>';
              })
            }

            // Price
            cart__html += '<div>';
            if(b.original_price != undefined && b.original_price != b.price){
              cart__html += '<small><s>'+money_prefix+' '+b.original_price+' '+money_suffix+'</s></small><br>';
            }
            cart__html += money_prefix+' '+b.price+' '+money_suffix+'</div>';

            // Remove cart button
            if(b.freebie != true){
              cart__html += '<a class="cart__remove" data-variant-id="'+b.variant.id+'" data-quantity="'+b.quantity+'" data-i_id="'+b.i_id+'"> <small> <svg class="svg-icon" id="Es_1" data-name="Es 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 486.4 486.4"><path d="M443.33,72.28H343.46V56A52.85,52.85,0,0,0,290.67,3.2H195.73A52.85,52.85,0,0,0,142.94,56V72.28H43.07a13.32,13.32,0,1,0,0,26.64H67.15V412A71.34,71.34,0,0,0,138.4,483.2H348A71.34,71.34,0,0,0,419.25,412v-313h24.08a13.32,13.32,0,0,0,0-26.64ZM169.58,56a26.2,26.2,0,0,1,26.15-26.16h94.94A26.21,26.21,0,0,1,316.82,56V72.28H169.58Zm223,356A44.69,44.69,0,0,1,348,456.56H138.4A44.7,44.7,0,0,1,93.79,412v-313H392.71V412Z"/><path d="M243.2,398.59a12.23,12.23,0,0,0,12.29-12.28V169.11a12.29,12.29,0,0,0-24.58,0v217.1A12.31,12.31,0,0,0,243.2,398.59Z"/><path d="M157.46,398.59a13.77,13.77,0,0,0,13.83-13.83V170.65a13.84,13.84,0,0,0-27.67,0V384.76A13.84,13.84,0,0,0,157.46,398.59Z"/><path d="M328.94,398.59a13.77,13.77,0,0,0,13.84-13.83V170.65a13.84,13.84,0,0,0-27.67,0V384.76A13.77,13.77,0,0,0,328.94,398.59Z"/></svg> </small> </a>';
            }


            // Promotion suggestion
            if(b.message.length > 0){
              cart__html += '<div class="grid grid--full">';
              $.each(b.message.length, function( index, c ) {
                cart__html += '<div class="h5 grid--full promotion-suggestion">{{ "cart.label.'+c.display_title+'" | t }}</div>';
              });
              cart__html += '</div>';
            }

            cart__html += '</div> </div> </div> <div class="grid__item large--one-whole"> <div class="grid--full"> <div class="grid__item one-half text-left">';



            // Quantity input
            if(b.freebie != true){

              cart__html += '<div class="cart-qty-adjust"> <a class="input-group-btn btn-qty-adjust btn" data-adjust="0"> - </a><input type="number" class="cart__quantity-selector" name="updates[]" id="updates_'+b.variant.id+'" value="'+b.quantity+'" min="0"> <a class="input-group-btn btn-qty-adjust btn" data-adjust="1"> + </a></div><input type="hidden" name="ids[]" value="'+b.variant.id+'"> <input type="hidden" name="i_ids[]" value="'+b.i_id+'">';

            }else{

              cart__html += '<input type="number" class="cart__quantity-selector" value="'+b.quantity+'" disabled="disabled" style="background: transparent; border-color: transparent;">';
            }

            cart__html += '</div> <div class="grid__item one-half text-right"> <span class="h5">';


            // if(b.original_price != undefined && b.original_price != b.price){
            //   cart__html += '<small class="cart-item__original-price"><s>'+money_prefix+' '+b.original_price+' '+money_suffix+'</s></small>';
            // }

            cart__html += money_prefix+' '+b.line_price+' '+money_suffix+'</span> </div> </div> </div> </div>';

          });

            cart__html += '</div> </div>';



          }else{

            cart__html += '<div class="cart__row"> <div class="grid--full"> <div class="grid__item large--one-whole"> <div class="order-item-wrapper"> <div class="order-item-img"> <a href="/'+ a.url+'" class="cart__image"> <img src="'+ a.img_url +'" alt="'+ a.product.title +'"> </a> </div> <div class="order-item-detail"> <a href="/'+ a.url+'" class="h5"> '+ a.product.title +' </a>'

            if(a.variant.title != "Default Tile"){
              cart__html += '<br><small>'+a.variant.title+'</small>';
            }

            if(a.properties && a.properties.length > 0){
              $.each(a.properties, function(index, property){
                  cart__html += '<br><small>'+property.first+': '+'</small><small>'+property.last+'</small>';
              })
            }

            cart__html += '<div> '+money_prefix+' '+a.price+' '+money_suffix+' </div> <a class="cart__remove" data-variant-id="'+a.variant.id+'" data-quantity="'+a.quantity+'" data-i_id="'+a.i_id+'"> <small> <svg class="svg-icon" id="Es_1" data-name="Es 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 486.4 486.4"><path d="M443.33,72.28H343.46V56A52.85,52.85,0,0,0,290.67,3.2H195.73A52.85,52.85,0,0,0,142.94,56V72.28H43.07a13.32,13.32,0,1,0,0,26.64H67.15V412A71.34,71.34,0,0,0,138.4,483.2H348A71.34,71.34,0,0,0,419.25,412v-313h24.08a13.32,13.32,0,0,0,0-26.64ZM169.58,56a26.2,26.2,0,0,1,26.15-26.16h94.94A26.21,26.21,0,0,1,316.82,56V72.28H169.58Zm223,356A44.69,44.69,0,0,1,348,456.56H138.4A44.7,44.7,0,0,1,93.79,412v-313H392.71V412Z"></path><path d="M243.2,398.59a12.23,12.23,0,0,0,12.29-12.28V169.11a12.29,12.29,0,0,0-24.58,0v217.1A12.31,12.31,0,0,0,243.2,398.59Z"></path><path d="M157.46,398.59a13.77,13.77,0,0,0,13.83-13.83V170.65a13.84,13.84,0,0,0-27.67,0V384.76A13.84,13.84,0,0,0,157.46,398.59Z"></path><path d="M328.94,398.59a13.77,13.77,0,0,0,13.84-13.83V170.65a13.84,13.84,0,0,0-27.67,0V384.76A13.77,13.77,0,0,0,328.94,398.59Z"></path></svg> </small> </a> </div> </div> </div> <div class="grid__item large--one-whole"> <div class="grid--full"> <div class="grid__item one-half text-left"> <div class="cart-qty-adjust"> '
            + '<a class="input-group-btn btn-qty-adjust btn" data-adjust="0"> - </a> <input type="number" class="cart__quantity-selector" name="updates[]" id="updates_'
            + a.variant.id+'" value="'+a.quantity+'" min="0"> <a class="input-group-btn btn-qty-adjust btn" data-adjust="1"> + </a> '
            + '</div> <input type="hidden" name="ids[]" value="'+a.variant.id+'"> <input type="hidden" name="i_ids[]" value="'+a.i_id+'"> </div> <div class="grid__item one-half text-right"> <span class="h5"> '+money_prefix+' '+a.line_price+' '+money_suffix+' </span> </div> </div> </div> </div> </div>';

          }

        });
        
        if(data.storewide_discounts.length > 0){
          var storewide_discounts_html = '';
          $.each(data.storewide_discounts, function( index, discounts ) {
            storewide_discounts_html += '<p>';
            storewide_discounts_html += '<span class="cart__subtotal-title">'+discounts.display_title+'</span>';
            storewide_discounts_html += '<span class="h5 cart__subtotal">'+discounts.amount+'</span>';
            storewide_discounts_html += '</p>';
          });
          $('#cart_storewide-discounts').empty();
          $('#cart_storewide-discounts').append(storewide_discounts_html);
        }

        $('#cartSubtotal').empty();
        $('#cartSubtotal').append(money_prefix+' '+ data.total_price+' '+money_suffix);

        if(data.voucher_discounts.length > 0){
          var cart__voucher = '';
          $.each(data.voucher_discounts, function( index, voucher ) {

            cart__voucher += '<div class="voucher_info"> <span class="cart__subtotal-title">'+voucher.display_title+' - '+voucher.voucher_code+'<small> <a id="remove_voucher" data-discount-id="'+voucher.id+'"> ({{ "cart.general.remove" | t }})</a></small> </span>';

            if(voucher.amount != null){
              cart__voucher += '<span class="h5 cart__subtotal">'+money_prefix+' '+voucher.amount+' '+money_suffix+'</span>';
            }

                // Voucher shipping
                if(voucher.shipping_method != null && voucher.shipping_method != undefined){
                  if(voucher.shipping_method.length > 0){
                    cart__voucher += ' <div> <small class="voucher_info-tooltip"> <svg class="svg-icon" width="14px" id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,9.58a1,1,0,0,0-1,1v8a1,1,0,0,0,2,0v-8A1,1,0,0,0,12,9.58Z"/><circle cx="12" cy="6.8" r="1.48"/><path d="M12,.85A11.15,11.15,0,1,0,23.15,12,11.16,11.16,0,0,0,12,.85Zm0,21A9.85,9.85,0,1,1,21.85,12,9.86,9.86,0,0,1,12,21.85Z"/></svg>{{ "cart.general.voucher_message_shipping_only" | t }} <span class="voucher_info-tooltip-content">'; 
                    
                    $.each(voucher.shipping_method, function( index, x ) {
                      cart__voucher += '<span>'+x+'</span>';
                    });

                    cart__voucher += '</span></small></div>';

                  }
                }

                // Payment shipping
                if(voucher.payment_method != null && voucher.payment_method != undefined){
                  if(voucher.payment_method.length > 0){
                    cart__voucher += ' <div> <small class="voucher_info-tooltip"> <svg class="svg-icon" width="14px" id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,9.58a1,1,0,0,0-1,1v8a1,1,0,0,0,2,0v-8A1,1,0,0,0,12,9.58Z"/><circle cx="12" cy="6.8" r="1.48"/><path d="M12,.85A11.15,11.15,0,1,0,23.15,12,11.16,11.16,0,0,0,12,.85Zm0,21A9.85,9.85,0,1,1,21.85,12,9.86,9.86,0,0,1,12,21.85Z"/></svg>{{ "cart.general.voucher_message_shipping_only" | t }} <span class="voucher_info-tooltip-content">'; 
                    
                    $.each(voucher.payment_method, function( index, x ) {
                      cart__voucher += '<span>'+x+'</span>';
                    });

                    cart__voucher += '</span></small></div>';

                  }
                }

                cart__voucher += '</div>';

              });


          $('#CartDrawer #cart__voucher-section').empty();
          $('#CartDrawer #cart__voucher-section').append(cart__voucher);

        }else{
          $('#CartDrawer #cart__voucher-section').empty();
        }
        // END


      }else{
        $('#hasCartItem').hide();
        $('#noCartItem').show();
        $('.cart-count').addClass('hidden-count');
      }

      if(data.errors != undefined && data.errors.length > 0){

          var errorMsg = '<div class="note errors">';

          $.each(data.errors, function( index, error ) {
              errorMsg += '<p>';
              errorMsg += error;
              errorMsg += '</p>';
          });
          
          errorMsg += '</div>';

          $('#cartDrawerError').append(errorMsg);

      }

      $('#promotion__code-input-wrapper').empty();
      if(data.active_voucher_promotion){
        if( data.voucher_discounts.length < 1 || (data.voucher_discounts.length > 0 && data.multiple_voucher_enabled == true)){
          var promotion_code_html = '<p class="promotion__code-input"> <span class="input-group"> <input type="text" class="input-group-field" name="voucher_code" placeholder="{{ "checkout.general.discount_code" | t }}"> <span class="input-group-btn"> <input type="button" class="btn" value="{{ "checkout.general.apply" | t }}" name="apply" id="applycode"> </span> </span> </p>';
          $('#promotion__code-input-wrapper').append(promotion_code_html);
        }
        
      }

      $('.cart-count').text(data.item_count);

      $('#CartDrawer .cart__row-wrapper').append(cart__html);    

      $('#CartDrawer #hasCartItem').removeClass('is-loading');

      if(data.errors != undefined && data.errors.length > 0){
        $("#CartDrawer .cart-drawer-content").animate({ scrollTop: 0 });
      }
  }


  theme.fetchCartDrawer = function(data){
      $('#CartDrawer #hasCartItem').addClass('is-loading');
      $.ajax({
        url: '/cart?retrieve=true',
        type: 'get',
        success: function(data, status) {
          // console.log(data);
          theme.cartDrawer(data);

          $('#CartDrawer #hasCartItem').removeClass('is-loading');
        },
        error: function(XMLHttpRequest, textStatus) {
          location.reload();
        }
      });
  }

  theme.updateCartDrawer = function(data){
    $('#CartDrawer #hasCartItem').addClass('is-loading');

    $.ajax({
      url: '/cart?retrieve=true',
      type: 'post',
      dataType: 'json',
      data: $('#CartDrawer form').serialize(),
      success: function(data, status) {
        // console.log(data);
        if(data.status == 'error'){

          $('#cartDrawerError').empty();

          var errorMsg = '<div class="note errors">';

          if(Array.isArray(data.data.message)){ 
            $.each(data.data.message, function( index, error ) {
                errorMsg += '<p>';
                errorMsg += error;
                errorMsg += '</p>';
            });
          }else{
              errorMsg += '<p>';
              errorMsg += data.data.message;
              errorMsg += '</p>';
          }
          
          errorMsg += '</div>';

          $('#cartDrawerError').append(errorMsg);
          $("#CartDrawer .cart-drawer-content").animate({ scrollTop: 0 });

        }else{

          theme.cartDrawer(data);
          
        }
        
        $('#CartDrawer #hasCartItem').removeClass('is-loading');
      },
      error: function(XMLHttpRequest, textStatus) {
        location.reload();
      }
    });
  }

  function debounce(func, wait, immediate) {
    var timeout;
    return function() {
        var context = this, args = arguments;
        var later = function() {
            timeout = null;
            if (!immediate) func.apply(context, args);
        };
        var callNow = immediate && !timeout;
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
        if (callNow) func.apply(context, args);
    };
  };

  $('body').on("change", '#CartDrawer input.cart__quantity-selector', function (){
    theme.updateCartDrawer();
  });


  $('#updateCartDrawer').click(function() {
    theme.updateCartDrawer();
  });

  $('body').on("click", ".btn-qty-adjust", function() {

    var $button = $(this);
    var oldValue = $button.parent().find("input.cart__quantity-selector").val();

    if ($button.attr('data-adjust') == 1) {
      var newVal = parseFloat(oldValue) + 1;
    } else {
    // Don't allow decrementing below zero
      if (oldValue > 0) {
        var newVal = parseFloat(oldValue) - 1;
      } else {
        newVal = 0;
      }
    }

    $button.parent().find("input").val(newVal);
    
  });
    
  $('body').on("click", ".btn-qty-adjust", debounce(function() {
  theme.updateCartDrawer();
  },350));

  $('button.checkout').click(function() {
    $(this).addClass('btn--loading');
  });

  var add_cart_success_html = '<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"> <g> <g> <path d="M383.841,171.838c-7.881-8.31-21.02-8.676-29.343-0.775L221.987,296.732l-63.204-64.893 c-8.005-8.213-21.13-8.393-29.35-0.387c-8.213,7.998-8.386,21.137-0.388,29.35l77.492,79.561 c4.061,4.172,9.458,6.275,14.869,6.275c5.134,0,10.268-1.896,14.288-5.694l147.373-139.762 C391.383,193.294,391.735,180.155,383.841,171.838z"/> </g> </g> <g> <g> <path d="M256,0C114.84,0,0,114.84,0,256s114.84,256,256,256s256-114.84,256-256S397.16,0,256,0z M256,470.487 c-118.265,0-214.487-96.214-214.487-214.487c0-118.265,96.221-214.487,214.487-214.487c118.272,0,214.487,96.221,214.487,214.487 C470.487,374.272,374.272,470.487,256,470.487z"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>';
      add_cart_success_html += '{{ "products.product.added_to_cart" | t }} <br><a class="CartDrawerTrigger">{{ "products.product.view_cart" | t }}</a>';

  function popToast(content) {
    var x = document.getElementById("toast"),
        y = document.getElementById("toastContent");

    y.innerHTML = content;
    x.className += " show";
    

    var hideToast = setTimeout(function(){ x.className = x.className.replace(" show", ""); }, 3000);
  }



  </script>


{% endif %}
